<!--
LoopSleuth Web: Clip Detail Page (DaVinci-inspired)
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ clip.filename }} - LoopSleuth</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="180x180" href="/static/favicon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/favicon-192x192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon-180x180.png">
    <style>
        .detail-flex {
            display: flex;
            flex-direction: row;
            gap: 2.5em;
            margin: 2.5em 2em 2em 2em;
            min-height: 60vh;
        }
        .detail-main {
            flex: 2 1 0%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        .detail-sidebar {
            flex: 1 1 0%;
            background: #181a1b;
            border-radius: 12px;
            box-shadow: 0 2px 12px #000a;
            padding: 2em 1.5em 1.5em 1.5em;
            min-width: 260px;
            max-width: 340px;
            color: #f0f4fa;
            display: flex;
            flex-direction: column;
            gap: 1.2em;
        }
        .video-player-container {
            width: 100%;
            max-width: 900px;
            background: #111;
            border-radius: 12px;
            box-shadow: 0 2px 12px #000a;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5em 1em 1.2em 1em;
        }
        .video-player-container video {
            width: 100%;
            max-width: 880px;
            aspect-ratio: 16/9;
            background: #111;
            border-radius: 8px;
        }
        .playback-bar {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 1em;
            margin-top: 0.7em;
            color: #f0f4fa;
        }
        .meta-label { color: #aaa; font-size: 0.97em; margin-right: 0.5em; }
        .meta-value { color: #f0f4fa; font-weight: 500; }
        .sidebar-section { margin-bottom: 1.2em; }
        .sidebar-section:last-child { margin-bottom: 0; }
        .sidebar-actions button { margin-right: 0.7em; }
        @media (max-width: 900px) {
            .detail-flex { flex-direction: column; gap: 1.5em; margin: 1.2em 0.5em; }
            .detail-sidebar { max-width: 100vw; min-width: 0; padding: 1.2em 0.7em; }
            .video-player-container { max-width: 100vw; padding: 0.7em 0.2em; }
        }
    </style>
</head>
<body>
    <a class="back-link" href="/">‚Üê Back to grid</a>
    <div class="detail-flex">
        <div class="detail-sidebar">
            <div class="sidebar-section">
                <div style="font-size:1.15em; font-weight:600;">{{ clip.filename }}</div>
                <div class="star" style="cursor:pointer; font-size:2em; margin-top:0.2em;" data-clip-id="{{ clip.id }}" onclick="toggleStar(event)" title="Toggle star">{% if clip.starred %}‚òÖ{% else %}‚òÜ{% endif %}</div>
            </div>
            <div class="sidebar-section">
                <div><span class="meta-label">Duration:</span> <span class="meta-value">
                    {# Robust duration formatting using .get() #}
                    {% set duration = clip.get('duration') %}
                    {% if duration is not none %}
                        {{ (duration // 60)|int }}:{{ '%02d' % (duration % 60) }} min
                    {% else %}
                        ??:?? min
                    {% endif %}
                </span></div>
                <div><span class="meta-label">Resolution:</span> <span class="meta-value">
                    {% set width = clip.get('width') %}
                    {% set height = clip.get('height') %}
                    {% if width is not none and height is not none %}
                        {{ width }}√ó{{ height }}
                    {% else %}
                        ?√ó?
                    {% endif %}
                </span></div>
                <div><span class="meta-label">Size:</span> <span class="meta-value">
                    {% set size = clip.get('size') %}
                    {% if size is not none %}
                        {{ size|filesizeformat }}
                    {% else %}
                        ?
                    {% endif %}
                </span></div>
                <div><span class="meta-label">Format:</span> <span class="meta-value">{{ clip.get('codec_name', 'Unknown')|default('Unknown') }}</span></div>
            </div>
            <div class="sidebar-section">
                <div style="margin-bottom:0.4em; color:#aaa;">Tags:</div>
                <span class="tags-text" id="tags-text-{{ clip.id }}">
                    {% for tag in clip.tags %}
                        <span class="tag-chip">{{ tag }}</span>
                    {% else %}
                        <span class="tag-chip tag-empty">No tags</span>
                    {% endfor %}
                </span>
                <button type="button" class="edit-tag-btn" data-clip-id="{{ clip.id }}" onclick="editTags(event)" style="margin-left:0.5em; font-size:0.9em;">‚úé</button>
                <span class="tags-edit" id="tags-edit-{{ clip.id }}" style="display:none;"></span>
                <input type="text" class="tag-input-new" id="tag-input-new-{{ clip.id }}" style="display:none; width:90%; margin-top:0.3em;" data-clip-id="{{ clip.id }}" placeholder="Add tag..." autocomplete="off" />
                <button type="button" class="save-tag-btn" id="save-tag-btn-{{ clip.id }}" style="display:none; margin-left:0.3em; font-size:0.9em;" data-clip-id="{{ clip.id }}" onclick="saveTags(event)">üíæ</button>
                <button type="button" class="cancel-tag-btn" id="cancel-tag-btn-{{ clip.id }}" style="display:none; margin-left:0.3em; font-size:0.9em;" data-clip-id="{{ clip.id }}" onclick="cancelEditTags(event)">‚úñ</button>
            </div>
            <div class="sidebar-section">
                <div style="margin-bottom:0.4em; color:#aaa;">Playlists:</div>
                <div class="playlists">
                    {% if all_playlists and all_playlists|length > 0 %}
                        {% for pl in all_playlists %}
                            <span class="playlist-badge{% if pl.is_member %} playlist-member{% else %} playlist-nonmember{% endif %}"
                                  data-playlist-id="{{ pl.id }}"
                                  tabindex="0"
                                  onclick="selectPlaylistFromBadge('{{ pl.id }}', '{{ pl.name|e }}')"
                                  onkeydown="if(event.key==='Enter'){selectPlaylistFromBadge('{{ pl.id }}', '{{ pl.name|e }}')}"
                            >{{ pl.name|escape }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="playlist-badge playlist-empty">No playlists</span>
                    {% endif %}
                </div>
                <button class="sidebar-btn" style="margin-top:0.7em;">Add to Playlist</button>
            </div>
            <div class="sidebar-section sidebar-actions">
                <button class="sidebar-btn" onclick="window.open('/media/{{ clip.path | urlencode }}', '_blank')">Download</button>
                <form method="post" action="/open_in_system/{{ clip.id }}" style="display:inline;" target="_blank">
                    <button class="sidebar-btn" type="submit">Open in System</button>
                </form>
            </div>
        </div>
        <div class="detail-main">
            <div class="video-player-container">
                <video id="clip-video" controls preload="auto">
                    <source src="/media/{{ clip.path | urlencode }}" type="{{ video_mime }}">
                    <div style="color:#ffb347; background:#222; padding:1em; border-radius:6px; margin-top:1em;">
                        <b>‚ö†Ô∏è This video format is not supported in your browser.</b><br>
                        <a href="/media/{{ clip.path | urlencode }}" download style="color:#7fd6d6;">Download original file</a> and play in a desktop video player.<br>
                        <span style="font-size:0.9em; color:#aaa;">(For best browser compatibility, use MP4/H.264/AAC.)</span>
                    </div>
                </video>
                <div class="playback-bar">
                    <!-- Placeholder: Custom controls can be added here (play/pause, seek, timecode, frame step, volume, speed) -->
                    <span id="current-time">00:00</span> / <span id="duration">00:00</span>
                    <input type="range" id="seek-bar" min="0" max="100" value="0" style="flex:1; margin:0 1em;">
                    <button id="play-pause-btn">‚èØ</button>
                    <button id="frame-back-btn">‚è™</button>
                    <button id="frame-fwd-btn">‚è©</button>
                    <input type="range" id="volume-bar" min="0" max="1" step="0.01" value="1" style="width:70px;">
                </div>
            </div>
        </div>
    </div>
    <script src="/static/clip_actions.js"></script>
    <script>
    // Patch: Ensure playlist badges in detail view are always selectable and visually indicate selection
    window.selectPlaylistFromBadge = function(playlistId, playlistName) {
        // Remove 'selected' class from all badges in the sidebar
        document.querySelectorAll('.detail-sidebar .playlist-badge').forEach(badge => {
            badge.classList.remove('selected');
        });
        // Add 'selected' class to the clicked badge
        const badge = document.querySelector('.detail-sidebar .playlist-badge[data-playlist-id="' + playlistId + '"]');
        if (badge) badge.classList.add('selected');
        // Also highlight the corresponding playlist in the sidebar and scroll into view
        document.querySelectorAll('#playlist-list .playlist-item').forEach(item => {
            const isSelected = item.dataset.playlistId == playlistId;
            item.classList.toggle('selected', isSelected);
            if (isSelected) {
                item.scrollIntoView({block: 'nearest', behavior: 'smooth'});
            }
        });
        // Trigger sidebar playlist selection and toast
        if (window.selectPlaylist) {
            window.selectPlaylist(Number(playlistId));
            if (window.showToast) window.showToast('Selected playlist: ' + playlistName);
        } else {
            alert('Playlist: ' + playlistName);
        }
    };
    </script>
</body>
</html> 